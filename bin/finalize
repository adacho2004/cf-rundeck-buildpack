#!/usr/bin/env bash

set -e

# Absolute path
BIN_DIR=$(cd $(dirname $0) && pwd)

BUILD_DIR=$1
CACHE_DIR=$2
DEPS_DIR=$3
INDEX=$4

##################################################################################
# Replacing placeholder with env variables, but not in Rundeck folder
##################################################################################

replaceEnvVariables () {
    FILENAME=$1
    TEMP_FILENAME=${FILENAME}_replaced

    echo "       handle $FILENAME"

    # Replace all environment variables with syntax ${MY_ENV_VAR} with the value
    # thanks to https://stackoverflow.com/questions/5274343/replacing-environment-variables-in-a-properties-file
    perl -p -e 's/\$\{([^}]+)\}/defined $ENV{$1} ? $ENV{$1} : $&/eg; s/\$\{([^}]+)\}//eg' ${FILENAME} > ${TEMP_FILENAME}
    mv ${TEMP_FILENAME} ${FILENAME}
}

echo "-----> Replacing placeholder with env variables"
cd ${BUILD_DIR}
export -f replaceEnvVariables
find -type f -not -path "./rundeck/*" -not -path "./.java/*" -exec bash -c 'replaceEnvVariables "$0"' {} \;

sleep 2

##################################################################################
# Move all user folders to Rundeck folder
##################################################################################
echo "-----> Moving user config to rundeck"
for DIRECTORY in */ ; do
    if [ "${DIRECTORY}" != "rundeck/" ] && [ "${DIRECTORY}" != ".java/" ]; then
        echo "       - $DIRECTORY"
        cp -r ${DIRECTORY} rundeck
        rm -rf ${DIRECTORY}
    fi
done

sleep 2

##################################################################################
# Handle role in web.xml
##################################################################################
echo "-----> Setting security role"
if [ -z ${RUNDECK_SECURITY_ROLE+x} ];
then
    echo "       RUNDECK_SECURITY_ROLE is not set, skipping..."
else
    WEB_XML_PATH=./rundeck/server/exp/webapp/WEB-INF/web.xml
    echo "       RUNDECK_SECURITY_ROLE is set to '$RUNDECK_SECURITY_ROLE' - replacing in ${WEB_XML_PATH}"
    sed -i "s/<role-name>user<\/role-name>/<role-name>${RUNDECK_SECURITY_ROLE}<\/role-name>/" ${WEB_XML_PATH}
fi

sleep 2

##################################################################################
# Setup ssh key
##################################################################################
echo "-----> Setting ssh key"

if [ -z ${RUNDECK_SSH_KEY+x} ];
then
    echo "       RUNDECK_SSH_KEY is not set, skipping..."
else
    SSH_DIR=/home/vcap/.ssh
    SSH_KEY=${SSH_DIR}/id_rsa
    echo "       RUNDECK_SSH_KEY is set - creating /home/vcap/.ssh/id_rsa"

    mkdir -p ${SSH_DIR}
    chmod 700 ${SSH_DIR}

    echo "${RUNDECK_SSH_KEY}" > ${SSH_KEY}
    chmod 600 ${SSH_KEY}
fi

sleep 2


##################################################################################
# Bind s3 log bucket
##################################################################################
if [ $(which jq) ]; then
    set +e
    ACCESS_KEY_ID=$(echo ${VCAP_SERVICES} | jq ".[\"aws-s3\"][0].credentials.ACCESS_KEY_ID" --raw-output)
    SECRET_ACCESS_KEY=$(echo ${VCAP_SERVICES} | jq ".[\"aws-s3\"][0].credentials.SECRET_ACCESS_KEY" --raw-output)
    if [ $? -eq 0 ]; then
        echo "\naws.accessKeyId=$ACCESS_KEY_ID\n" >> ${BUILD_DIR}/server/config/rundeck-config.properties
        echo "aws.secretKey=$SECRET_ACCESS_KEY\n" >> ${BUILD_DIR}/server/config/rundeck-config.properties
    fi
    set -e
fi


##################################################################################
# Create start script
##################################################################################
echo "-----> Creating start scripts"
cp ${BIN_DIR}/../startRundeck.sh ${BUILD_DIR}/startRundeck.sh
chmod +x ${BUILD_DIR}/startRundeck.sh


echo "-----> Done :)"
