#!/usr/bin/env bash

# Absolute path
BIN_DIR=$(cd $(dirname $0) && pwd)

BUILD_DIR=$1
CACHE_DIR=$2
DEPS_DIR=$3
INDEX=$4

echo "-----> Creating start script"
cp ${BIN_DIR}/../startRundeck.sh ${BUILD_DIR}/startRundeck.sh
chmod +x ${BUILD_DIR}/startRundeck.sh

echo "-----> Installing Rundeck"
export PATH=$PATH:${BUILD_DIR}/.java/bin
export RDECK_BASE=${BUILD_DIR}

java -Drdeck.base="/home/vcap/app" -jar ${BUILD_DIR}/rundeck.jar -b ${BUILD_DIR} --installonly

echo "-----> Symlinking properties"
cd ${BUILD_DIR}/server/config
rm -f rundeck-config.properties
ln -s ../../rundeck-config.properties rundeck-config.properties


# If there is a jaas login configuration file in the uploaded files
if [ -f ${BUILD_DIR}/jaas-login.conf ]; then
    echo "       Found jaas-login.conf, symlinking..."
    ln -s ../../jaas-login.conf jaas-login.conf
fi