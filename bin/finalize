#!/usr/bin/env bash

set -e

# Absolute path
BIN_DIR=$(cd $(dirname $0) && pwd)

BUILD_DIR=$1
CACHE_DIR=$2
DEPS_DIR=$3
INDEX=$4

RUNDECK_APP_DIR=${BUILD_DIR}/rundeck

mkdir -p "$BUILD_DIR/rundeck"

echo "-----> Creating start scripts"
cp ${BIN_DIR}/../startRundeck.sh ${RUNDECK_APP_DIR}/startRundeck.sh
chmod +x ${RUNDECK_APP_DIR}/startRundeck.sh

echo "-----> Installing Rundeck"
export PATH=$PATH:${BUILD_DIR}/.java/bin
export RDECK_BASE=${RUNDECK_APP_DIR}

java -jar ${RUNDECK_APP_DIR}/rundeck.jar \
        -b ${RUNDECK_APP_DIR} \
        --installonly \
        -c "$BUILD_DIR/config" \
        -d

mv ${RUNDECK_APP_DIR}/server/config ${BUILD_DIR}